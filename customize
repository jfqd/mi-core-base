#!/usr/bin/bash

set -o errexit

PATH=/opt/local/gnu/bin:/opt/local/bin:/opt/local/sbin:/usr/bin:/usr/sbin

# nagios plugins
NAGIOS_PLUGIN_VERSION='0.1.3'

# Munin plugins
MUNIN_PLUGIN_VERSION='0.12.12'
MUNIN_PLUGINS="
	nullmailer
	cputime
	df
	load
	uptime
	users
	proc_state
	vfs_bytes
	vfs_iops
	vfs_latency
	if_net0
	pkg_audit
	memory_cap
	swap_cap
	smf
	tcp
	udp
	openfiles
"

echo "* Use the qutic pkgsrc mirror"
gsed -i 's:pkgsrc.joyent.com:pkgsrc.qutic.com:g' /opt/local/etc/pkgin/repositories.conf
gsed -i 's:pkgsrc.joyent.com:pkgsrc.qutic.com:g' /opt/local/etc/pkg_install.conf
pkg_admin rebuild || true
pkgin -y up || true

# import key
rm /opt/local/etc/gnupg/pkgsrc.gpg || true
mkdir -p /opt/local/etc/gnupg || true
curl -s https://download.qutic.com/extras/pkgsrc-trunk.gpg > /opt/local/etc/gnupg/pkgsrc.gpg

# fix munin
pkg_add https://download.qutic.com/extras/munin-common-2.0.30.tgz || true
pkg_add https://download.qutic.com/extras/munin-node-2.0.30.tgz   || true

# NRPE
echo "* Download and install community nagios plugins"
curl -L -s https://github.com/jfqd/smartos-nagios-plugins/archive/v${NAGIOS_PLUGIN_VERSION}.tar.gz | gtar xz -C /opt/local/libexec/nagios --strip-components=1
rm /opt/local/libexec/nagios/.gitignore /opt/local/libexec/nagios/README.md

## MUNIN
echo "* Create munin template file that will be used during mdata setup"
cp /opt/local/etc/munin/munin-node.conf /opt/local/etc/munin/munin-node.conf.tpl

echo "* Download and install community munin plugins (overwrite all other plugins)"
curl -L -s https://github.com/jfqd/smartos-munin-plugins/archive/v${MUNIN_PLUGIN_VERSION}.tar.gz | gtar xz -C /opt/local/lib/munin/plugins --strip-components=1

echo "* Activate munin plugins"
/opt/qutic/bin/munin-node-plugins ${MUNIN_PLUGINS}

# get latest updates
pkgin update
pkgin -y upgrade || true

mkdir -p /root/.gnupg
chmod 0700 /root/.gnupg
echo "keyserver pgp.mit.edu" > /root/.gnupg/gpg.conf
chmod 0600 /root/.gnupg/gpg.conf

echo "* Cleanup home/admin because of delegate dataset usage"
rm -rf /home/admin/.[^.]*

# bash extensions
cat >> /etc/skel/.bashrc << EOF
PS1='\[\033[01;32m\]\u@\h\[\033[00m\]:\[\033[01;34m\]\W\[\033[00m\]\$ '
alias la="ls -al"
alias t="cd /var/log/ && tail -n 50 -f "
alias msg="/usr/bin/tail -n 50 -f /var/adm/messages"
LANG=en_US.UTF-8
LANGUAGE=en_US.UTF-8
LC_MONETARY=de_DE.UTF-8
LC_TIME=de_DE.UTF-8
LC_CTYPE=de_DE.UTF-8
LC_NUMERIC=de_DE.UTF-8
LC_MESSAGES=C
EDITOR=nano
HISTSIZE=2000
HISTFILESIZE=25000
HISTTIMEFORMAT="[%d.%m.%Y %T] "
EOF

# nanorc extensions
cat >> /opt/local/etc/nanorc << EOF
include "/opt/local/share/nano/ruby.nanorc"
include "/opt/local/share/nano/sh.nanorc"
include "/opt/local/share/nano/nanorc.nanorc"
include "/opt/local/share/nano/html.nanorc"
include "/opt/local/share/nano/css.nanorc"
include "/opt/local/share/nano/javascript.nanorc"
EOF

echo "* Create missing log-files"
touch /var/log/mail.log
touch /var/log/ipf.log
touch /var/log/auth.log
rm /var/log/authlog
rm /var/log/maillog

gsed -i \
     -e 's:authlog:auth.log:' \
     -e 's:maillog:mail.log:' \
     /etc/logadm.conf

# echo "* Enable ipfilter"
# svcadm enable svc:/network/ipfilter:default

echo "* setup and load beaver"
pip install beaver
touch /var/log/beaver.log
chown nobody:nobody /var/log/beaver.log

echo "* link nullmailer log"
mkdir -p /var/log/nullmailer
ln -nfs /var/svc/log/pkgsrc-nullmailer:default.log /var/log/nullmailer/mail.log

echo "* link zoneinit log"
ln -nfs /var/svc/log/system-zoneinit:default.log /var/log/system_zoneinit_log

echo "* load startup.xml"
/usr/sbin/svccfg import /svc/manifest/site/startup.xml
svcadm enable svc:/site/startup:default

echo "* Cleaning up."
cp /etc/skel/.bashrc /root/.bashrc
history -c

# Provide workaround for /.zonecontrol/metadata.sock issue
# https://github.com/joyent/smtools/issues/3
gsed -i 's:^rm -f /.zonecontrol/metadata.sock$:rm -f /.zonecontrol/metadata.sock || true:g' \
	/opt/local/bin/sm-prepare-image

echo "* Prepare image"
sm-prepare-image -y
